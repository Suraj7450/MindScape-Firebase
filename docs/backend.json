{
  "entities": {
    "MindMap": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "MindMap",
      "type": "object",
      "description": "Represents a mind map created within the application.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the mind map entity."
        },
        "topic": {
          "type": "string",
          "description": "The main topic of the mind map."
        },
        "summary": {
            "type": "string",
            "description": "A short, 1-2 sentence AI-generated summary of the mind map's content."
        },
        "subTopicIds": {
          "type": "array",
          "description": "References to SubTopics. (Relationship: MindMap 1:N SubTopic)",
          "items": {
            "type": "string"
          }
        },
        "userId": {
          "type": "string",
          "description": "Reference to User. (Relationship: User 1:N MindMap)"
        },
        "thumbnailUrl": {
          "type": "string",
          "description": "URL for the AI-generated thumbnail image of the mind map."
        },
        "thumbnailPrompt": {
          "type": "string",
          "description": "The prompt used to generate the thumbnail image."
        }
      },
      "required": [
        "id",
        "topic",
        "userId",
        "summary"
      ]
    },
    "SubTopic": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "SubTopic",
      "type": "object",
      "description": "Represents a sub-topic within a mind map.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the sub-topic entity."
        },
        "mindMapId": {
          "type": "string",
          "description": "Reference to MindMap. (Relationship: MindMap 1:N SubTopic)"
        },
        "name": {
          "type": "string",
          "description": "The name of the sub-topic."
        },
        "categoryIds": {
          "type": "array",
          "description": "References to Categories. (Relationship: SubTopic 1:N Category)",
          "items": {
            "type": "string"
          }
        }
      },
      "required": [
        "id",
        "mindMapId",
        "name"
      ]
    },
    "Category": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Category",
      "type": "object",
      "description": "Represents a category within a sub-topic.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the category entity."
        },
        "subTopicId": {
          "type": "string",
          "description": "Reference to SubTopic. (Relationship: SubTopic 1:N Category)"
        },
        "name": {
          "type": "string",
          "description": "The name of the category."
        },
        "subCategoryIds": {
          "type": "array",
          "description": "References to SubCategories. (Relationship: Category 1:N SubCategory)",
          "items": {
            "type": "string"
          }
        }
      },
      "required": [
        "id",
        "subTopicId",
        "name"
      ]
    },
    "SubCategory": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "SubCategory",
      "type": "object",
      "description": "Represents a sub-category within a category.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the sub-category entity."
        },
        "categoryId": {
          "type": "string",
          "description": "Reference to Category. (Relationship: Category 1:N SubCategory)"
        },
        "name": {
          "type": "string",
          "description": "The name of the sub-category."
        },
        "briefDescription": {
          "type": "string",
          "description": "A brief description of the sub-category."
        }
      },
      "required": [
        "id",
        "categoryId",
        "name",
        "briefDescription"
      ]
    },
    "User": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "User",
      "type": "object",
      "description": "Represents a user of the application.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the user entity."
        },
        "email": {
          "type": "string",
          "description": "The email address of the user.",
          "format": "email"
        },
        "username": {
          "type": "string",
          "description": "The username of the user."
        }
      },
      "required": [
        "id",
        "email",
        "username"
      ]
    }
  },
  "auth": {
    "providers": [
      "password",
      "anonymous"
    ]
  },
  "firestore": {
    "structure": [
      {
        "path": "/users/{userId}",
        "definition": {
          "entityName": "User",
          "schema": {
            "$ref": "#/entities/User"
          },
          "description": "Stores user profiles. Path-based ownership, where the {userId} corresponds to the authenticated user's UID.",
          "params": [
            {
              "name": "userId",
              "description": "The unique identifier of the user."
            }
          ]
        }
      },
      {
        "path": "/users/{userId}/mindmaps/{mindMapId}",
        "definition": {
          "entityName": "MindMap",
          "schema": {
            "$ref": "#/entities/MindMap"
          },
          "description": "Stores mind maps owned by a specific user. Path-based ownership, ensuring only the user can access their own mind maps. Includes denormalized 'userId' for authorization independence.",
          "params": [
            {
              "name": "userId",
              "description": "The unique identifier of the user."
            },
            {
              "name": "mindMapId",
              "description": "The unique identifier of the mind map."
            }
          ]
        }
      },
      {
        "path": "/publicMindmaps/{mindMapId}",
        "definition": {
          "entityName": "MindMap",
          "schema": {
            "$ref": "#/entities/MindMap"
          },
          "description": "Stores mind maps that have been shared publicly. Anyone can read these, but only authenticated users can create them.",
          "params": [
            {
              "name": "mindMapId",
              "description": "The unique identifier of the public mind map."
            }
          ]
        }
      },
      {
        "path": "/users/{userId}/mindmaps/{mindMapId}/subtopics/{subTopicId}",
        "definition": {
          "entityName": "SubTopic",
          "schema": {
            "$ref": "#/entities/SubTopic"
          },
          "description": "Stores sub-topics associated with a specific mind map. Path-based ownership, inheriting access from the parent mind map. Includes denormalized 'mindMapId' and 'userId' for authorization independence.",
          "params": [
            {
              "name": "userId",
              "description": "The unique identifier of the user."
            },
            {
              "name": "mindMapId",
              "description": "The unique identifier of the mind map."
            },
            {
              "name": "subTopicId",
              "description": "The unique identifier of the sub-topic."
            }
          ]
        }
      },
      {
        "path": "/users/{userId}/mindmaps/{mindMapId}/subtopics/{subTopicId}/categories/{categoryId}",
        "definition": {
          "entityName": "Category",
          "schema": {
            "$ref": "#/entities/Category"
          },
          "description": "Stores categories associated with a specific sub-topic. Path-based ownership, inheriting access from the parent sub-topic. Includes denormalized 'subTopicId', 'mindMapId', and 'userId' for authorization independence.",
          "params": [
            {
              "name": "userId",
              "description": "The unique identifier of the user."
            },
            {
              "name": "mindMapId",
              "description": "The unique identifier of the mind map."
            },
            {
              "name": "subTopicId",
              "description": "The unique identifier of the sub-topic."
            },
            {
              "name": "categoryId",
              "description": "The unique identifier of the category."
            }
          ]
        }
      },
      {
        "path": "/users/{userId}/mindmaps/{mindMapId}/subtopics/{subTopicId}/categories/{categoryId}/subcategories/{subCategoryId}",
        "definition": {
          "entityName": "SubCategory",
          "schema": {
            "$ref": "#/entities/SubCategory"
          },
          "description": "Stores sub-categories associated with a specific category. Path-based ownership, inheriting access from the parent category. Includes denormalized 'categoryId', 'subTopicId', 'mindMapId', and 'userId' for authorization independence.",
          "params": [
            {
              "name": "userId",
              "description": "The unique identifier of the user."
            },
            {
              "name": "mindMapId",
              "description": "The unique identifier of the mind map."
            },
            {
              "name": "subTopicId",
              "description": "The unique identifier of the sub-topic."
            },
            {
              "name": "categoryId",
              "description": "The unique identifier of the category."
            },
            {
              "name": "subCategoryId",
              "description": "The unique identifier of the sub-category."
            }
          ]
        }
      }
    ],
    "reasoning": "The Firestore structure is designed to be secure, scalable, and easily debuggable, following the principles of Authorization Independence, Clarity of Intent, DBAC (Database-Based Access Control), and QAPs (Rules are not Filters). The structure utilizes path-based ownership for user-specific data and denormalization for authorization independence.\n\n*   **Authorization Independence:** Each entity's access control is determined by its location in the path hierarchy. For example, MindMaps are stored under `/users/{userId}/mindmaps/{mindMapId}`, making access control dependent on the `userId` and independent of other documents. This is achieved by associating each MindMap directly with its owner (User). Similar strategies are used for SubTopics, Categories, and SubCategories.\n*   **Clarity of Intent:** The path-based structure clearly indicates ownership and relationships between entities.\n*   **DBAC:**  Authorization relies solely on `request.auth.uid`, avoiding custom claims.\n*   **QAPs:** The structure facilitates secure `list` operations by segregating data based on ownership. Listing mindmaps for a specific user is done via `/users/{userId}/mindmaps`. This also applies to listing SubTopics, Categories and SubCategories under their respective parent documents.\n*   **Invariants:**  Ownership and relationships are enforced through the path structure. Timestamps are omitted, but could be added to each schema without impacting the authorization strategy."
  }
}
